import java.io.IOException;
import java.math.BigInteger;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.regex.Pattern;

public class App {
    public static void main(String args[]) throws IOException {
        // calculate(true, "example.txt", 10605);
        // calculate(true, "mypuzzle.txt", 51075);
        calculate(false, "example.txt", 2713310158l);
        // calculate(false, "mypuzzle.txt", 0);
    }    

    private static void calculate(Boolean assignment1, String dataset, long expected) throws IOException {
        var puzzle = Files.readString(Paths.get("datasets/" + dataset));

        // TODO
        // Parse monkeys
        // var regex = 
        // var matcher = Pattern.compile("move ([0-9]+) from ([0-9]+) to ([0-9]+)").matcher(puzzleParts[1]);
        // while (matcher.find()) {
        //     var crateCount = Integer.parseInt(matcher.group(1));
        //     var fromStack = Integer.parseInt(matcher.group(2));
        //     var toStack = Integer.parseInt(matcher.group(3));
        var monkeys = new ArrayList<Monkey>();
        String regex = """
Monkey [0-9]:
  Starting items: (.+)
  Operation: new = (.+) ([\\*|\\+]) (.+)
  Test: divisible by ([0-9]+)
    If true: throw to monkey ([0-9])
    If false: throw to monkey ([0-9])""";
        var matcher = Pattern.compile(regex).matcher(puzzle);
        while (matcher.find()) {
            // var startingItems = Arrays.stream(matcher.group(1).split(", ")).mapToLong(Long::parseLong).boxed().toList();
            var startingItems = Arrays.stream(matcher.group(1).split(", ")).map(BigInteger::new).toList();
            var operation1 = matcher.group(2);
            var operation2 = matcher.group(3);
            var operation3 = matcher.group(4);
            var divisibleBy = Integer.parseInt(matcher.group(5));
            var trueMonkey = Integer.parseInt(matcher.group(6));
            var falseMonkey = Integer.parseInt(matcher.group(7));

            monkeys.add(new Monkey(startingItems, operation1, operation2, operation3, divisibleBy, trueMonkey, falseMonkey));
        }

        System.out.println("Process monkeys");
        var inspectCount = new Integer[monkeys.size()]; // todo: consider adding this to class Monkey
        Arrays.fill(inspectCount, 0);
        for (var i = 1; i <= 20; i++) {
            System.out.println("i="+i);
            for (var j = 0; j < monkeys.size(); j++) {                
                // System.out.println(String.format("i=%s,j=%s", i, j));
                var monkey = monkeys.get(j);

                // Inspect
                // inspectCount[j] += monkey.items.size();
                // monkey.executeOperation();
                for (var k = 0; k < monkey.items.size(); k++) {
                    var oldItem = monkey.items.get(k);
                    var newItem = monkey.items.get(k);
                    
                    var operation3Value = (monkey.operation3.equals("old")) ? newItem : new BigInteger(monkey.operation3);
                    if (monkey.operation2.equals("*"))
                        newItem = newItem.multiply(operation3Value);
                    else
                        newItem = newItem.add(operation3Value);

                    // var operation3Value = (monkey.operation3.equals("old")) ? newItem : Long.valueOf(monkey.operation3);
                    // if (monkey.operation2.equals("*"))
                    //     newItem *= operation3Value;
                    // else
                    //     newItem += operation3Value;
                    
                    // newItem /= 3; // Assignment 1
                    // newItem = newItem.divide(BigInteger.valueOf(3));
                    monkey.items.set(k, newItem);                    
                    inspectCount[j]++;

                    System.out.println(String.format("operation=%s, operation3Value=%s, oldItem=%s, newItem=%s, divisible=%s", monkey.operation2, operation3Value, oldItem, newItem, monkey.divisibleBy));
                }

                // Throw
                for (var item : monkey.items) {
                    // monkeys.get((item % monkey.divisibleBy == 0) ? monkey.trueMonkey : monkey.falseMonkey).items.add(item);

                    // if (item.mod(BigInteger.valueOf(monkey.divisibleBy)) == BigInteger.valueOf(0)) {
                    //     item = BigInteger.valueOf(0);
                    // }
                    

                    if ((item.mod(BigInteger.valueOf(monkey.divisibleBy)) == BigInteger.valueOf(0))) {
                        System.out.println("trueMonkey");
                        // item = item.divide(BigInteger.valueOf(monkey.divisibleBy));
                        // item = BigInteger.valueOf(0);
                        monkeys.get(monkey.trueMonkey).items.add(item);
                    } else {
                        monkeys.get(monkey.falseMonkey).items.add(item);
                    }


                }
                monkey.items.clear();
            }
        }

        // for (var monkey : monkeys)
        //     System.out.println(monkey);
        for (var monkey : inspectCount)
            System.out.println(monkey);

        Arrays.sort(inspectCount, Collections.reverseOrder());
        var monkeyBusiness = inspectCount[0] * inspectCount[1];

        // Print results
        var actual = monkeyBusiness;
        System.out.println(String.format("Assignment %s - dataset=%s [%s]\t: expected=%s, actual=%s", 
            assignment1 ? "1" : "2",
            dataset,
            expected == actual ? "PASSED" : "FAILED",
            expected,
            actual));
    }

    private static class Monkey {
        public final List<BigInteger> items;
        public final String operation1;
        public final String operation2;
        public final String operation3;
        public final int divisibleBy; // TODO: rename to divisibleFactor?
        public final int trueMonkey;
        public final int falseMonkey;

        public Monkey(List<BigInteger> items, String operation1, String operation2, String operation3, int divisbleBy, int trueMonkey, int falseMonkey) {
            this.items = new ArrayList<>(items);
            this.operation1 = operation1;
            this.operation2 = operation2;
            this.operation3 = operation3;
            this.divisibleBy = divisbleBy;
            this.trueMonkey = trueMonkey;
            this.falseMonkey = falseMonkey;
        }

        // public void executeOperation() {
        //     for (var i = 0; i < items.size(); i++) {
        //         var newItem = items.get(i);
        //         var operation3Value = (operation3.equals("old")) ? newItem : new BigInteger(operation3);
        //         if (operation2.equals("*"))
        //             newItem = newItem.multiply(BigInteger.valueOf(operation3Value.intValue()));
        //         else
        //             newItem = newItem.add(BigInteger.valueOf(operation3Value.intValue()));
        //         // newItem /= 3;
        //         // newItem = newItem.divide(BigInteger.valueOf(3));
        //         items.set(i, newItem);
        //     }
        // }

        @Override public String toString() {
            return String.format("""
                    items=%s
                    operation1=%s
                    operation2=%s
                    operation3=%s
                    divisbleBy=%s
                    trueMonkey=%s
                    falseMonkey=%s""", items.toString(), operation1, operation2, operation3, divisibleBy, trueMonkey, falseMonkey);
        }
    }
}
